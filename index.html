<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Ø¨ÙˆØ§Ø¨Ø© Ø§Ù„Ù…Ø­Ø§Ø¶Ø±Ø§Øª</title>
  <style>
    :root{
      --accent: #0b74ff;
      --accent-dark: #0a5ee0;
      --bg: #f5f7fb;
      --card: #ffffff;
      --muted: #6b7280;
      --danger: #ef4444;
      --success: #10b981;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family: "Segoe UI", "Noto Naskh Arabic", Tahoma, Arial, sans-serif;
      background: linear-gradient(180deg,#f7fbff 0%,var(--bg) 100%);
      color:#0f172a;
      -webkit-font-smoothing:antialiased;
      padding:28px;
      direction: rtl;
    }
    .container{max-width:920px;margin:0 auto}
    header{
      display:flex;align-items:center;justify-content:space-between;gap:12px;margin-bottom:20px;
    }
    .brand{display:flex;gap:12px;align-items:center}
    .logo{
      width:64px;height:64px;border-radius:14px;
      background:linear-gradient(135deg,var(--accent),#6d28d9);
      color:white;display:flex;align-items:center;justify-content:center;font-weight:700;font-size:22px;
      box-shadow:0 8px 26px rgba(11,116,255,0.12);
    }
    .title h1{margin:0;font-size:20px}
    .title p{margin:0;font-size:13px;color:var(--muted)}
    .master{
      text-align:right;
    }
    .master .label{font-size:12px;color:var(--muted);margin-bottom:6px}
    .master .name{
      display:inline-block;padding:8px 12px;border-radius:10px;background:var(--card);box-shadow:0 2px 8px rgba(15,23,42,0.06);
      cursor:text;font-weight:700;
    }

    main{display:grid;grid-template-columns:1fr;gap:18px}

    .card{
      background:var(--card);border-radius:12px;padding:18px;box-shadow:0 8px 30px rgba(15,23,42,0.04);
    }

    label{font-size:13px;color:var(--muted);display:block;margin-bottom:8px}
    select, input[type="text"], input[type="url"]{
      width:100%;padding:12px 14px;border-radius:10px;border:1px solid #e6eef9;background:#fbfdff;font-size:15px;
      outline:none;
    }
    .row{display:flex;gap:12px;flex-wrap:wrap}
    .col{flex:1;min-width:180px}

    .btn{
      display:inline-flex;align-items:center;gap:10px;padding:10px 16px;border-radius:12px;border:0;background:var(--accent);color:white;font-weight:800;cursor:pointer;
      box-shadow:0 8px 20px rgba(11,116,255,0.12);
    }
    .btn.ghost{background:transparent;color:var(--accent);border:1px solid rgba(11,116,255,0.12);box-shadow:none}
    .muted{color:var(--muted);font-size:13px}

    .video-wrap{margin-top:14px;display:flex;flex-direction:column;gap:12px;align-items:center}
    iframe.video{width:100%;height:480px;border-radius:12px;border:none;background:#000;display:none;max-width:900px}
    .video-card{width:100%;max-width:920px}

    .meta-row{display:flex;justify-content:space-between;align-items:center;width:100%}
    .meta-row .lesson{font-weight:800}
    .meta-row .status{color:var(--muted);font-size:13px}

    footer{margin-top:18px;text-align:center;color:var(--muted);font-size:13px}

    /* snackbar */
    .snackbar {
      position: fixed;
      left: 50%;
      transform: translateX(-50%);
      bottom: -100px;
      background: #111827;
      color: white;
      padding: 12px 18px;
      border-radius: 10px;
      box-shadow: 0 8px 30px rgba(2,6,23,0.3);
      transition: bottom 0.35s ease, opacity 0.35s ease;
      opacity: 0;
      z-index: 9999;
      max-width: 92%;
    }
    .snackbar.show { bottom: 28px; opacity: 1; }
    .snackbar.success { background: var(--success); color: white; }
    .snackbar.error { background: var(--danger); color: white; }

    /* spinner */
    .spinner{
      width:20px;height:20px;border-radius:50%;border:3px solid rgba(0,0,0,0.08);border-top-color:var(--accent);animation:spin 0.9s linear infinite;display:inline-block;margin-left:10px;
    }
    @keyframes spin{to{transform:rotate(360deg)}}

    .manual-area{display:none;width:100%;gap:8px;align-items:center;margin-top:8px}
    .manual-area input{flex:1}

    @media (max-width:820px){
      iframe.video{height:320px}
    }
  </style>
</head>
<body>
  <div class="container">
    <header>
      <div class="brand">
        <div class="logo">M</div>
        <div class="title">
          <h1>Ø¨ÙˆØ§Ø¨Ø© Ø§Ù„Ù…Ø­Ø§Ø¶Ø±Ø§Øª</h1>
        </div>
      </div>

      <div class="master">
        <div class="label"></div>
        <!-- ØºÙŠÙ‘Ø± Ø§Ù„Ù‚ÙŠÙ…Ø© ÙÙŠ Ø§Ù„ÙƒÙˆØ¯ Ø£Ùˆ Ù‡Ù†Ø§ (ÙŠØ­ÙØ¸ Ù…Ø­Ù„ÙŠÙ‹Ø§) -->
        <div id="masterName" class="name" contenteditable="true" title="Ø§Ø¶ØºØ· Ù„ØªØ¹Ø¯ÙŠÙ„ Ø§Ø³Ù… Ø§Ù„Ù…Ø¯Ø±Ø³"> Ø¯ÙƒØªÙˆØ± Ø§ÙŠÙ…Ù† Ø¹Ø¨Ø¯Ø§Ù„Ø±Ø­ÙŠÙ… </div>
      </div>
    </header>

    <main>
      <section class="card">
        <div style="display:flex;justify-content:space-between;align-items:center;gap:12px;flex-wrap:wrap">
          <div>
            <strong>Ù…Ø´Ø§Ù‡Ø¯Ø© Ø§Ù„Ù…Ø­Ø§Ø¶Ø±Ø§Øª</strong>
            <div class="muted">Ø§Ø®ØªØ± ØµÙÙƒØŒ Ø«Ù… Ø£Ø¯Ø®Ù„ Ø§Ù„ÙƒÙˆØ¯ ÙˆØ§Ø¶ØºØ· Ø¹Ø±Ø¶</div>
          </div>
          
        </div>

        <div style="height:12px"></div>

        <div class="row">
          <div class="col">
            <label>Ø§Ø®ØªØ± Ø§Ù„ØµÙ</label>
            <select id="gradeSelect">
              <option value="CodeGrade1">Ø§ÙˆÙ„ÙŠ Ø«Ø§Ù†ÙˆÙŠ</option>
              <option value="CodeGrade2">ØªØ§Ù†ÙŠÙ‡ Ø«Ø§Ù†ÙˆÙŠ</option>
              <option value="CodeGrade3">ØªØ§Ù„ØªÙ‡ Ø«Ø§Ù†ÙˆÙŠ</option>
            </select>
          </div>

          <div class="col">
            <label>Ø£Ø¯Ø®Ù„ Ø§Ù„ÙƒÙˆØ¯</label>
            <input id="studentCode" type="text" placeholder="Ù…Ø«Ø§Ù„: AB12CD34" />
          </div>

          <div style="display:flex;align-items:flex-end;gap:8px">
            <button id="showBtn" class="btn">Ø¹Ø±Ø¶ Ø§Ù„Ù…Ø­Ø§Ø¶Ø±Ø©</button>
            <button id="examsBtn" class="btn ghost">Ø§Ù„Ø§Ù…ØªØ­Ø§Ù†Ø§Øª</button>
          </div>
        </div>

        <div id="loadingRow" style="margin-top:12px;display:none;align-items:center">
          <div class="spinner"></div>
          <div style="margin-right:10px;color:var(--muted)">Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ø§Ù„ÙƒÙˆØ¯ ÙˆÙØªØ­ Ø§Ù„Ù…Ø­Ø§Ø¶Ø±Ø©...</div>
        </div>

        <div class="video-card" style="margin-top:14px">
          <div class="card video-wrap" style="padding:12px">
            <div class="meta-row">
              <div class="lesson" id="videoTitle">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ø­Ø§Ø¶Ø±Ø© Ø­Ø§Ù„ÙŠØ§Ù‹</div>
              <div class="status" id="videoStatus">Ø§Ø¯Ø®Ù„ Ø§Ù„ÙƒÙˆØ¯ ÙˆØ§Ø¶ØºØ· Ø¹Ø±Ø¶</div>
            </div>

            <iframe id="videoFrame" class="video" src="" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" allowfullscreen></iframe>

            <div id="manualArea" class="manual-area">
              <input id="manualLink" type="url" placeholder="Ø¥Ø°Ø§ Ù„Ù… ÙŠÙˆØ¬Ø¯ Ø±Ø§Ø¨Ø· ÙÙŠ Ø§Ù„Ø´ÙŠØª: Ø¶Ø¹ Ø±Ø§Ø¨Ø· Ø§Ù„ÙÙŠØ¯ÙŠÙˆ (youtube Ø£Ùˆ embed)" />
              <button id="useManual" class="btn">Ø§Ø³ØªØ®Ø¯Ù… Ø§Ù„Ù„ÙŠÙ†Ùƒ</button>
            </div>

          </div>
        </div>

      </section>

     
        </div>
      </footer>
    </main>
  </div>

  <!-- Snackbar -->
  <div id="snackbar" class="snackbar">Ù†Øµ ØªØ¬Ø±ÙŠØ¨ÙŠ</div>

<script>
/*
  âœ³ï¸ Ø¹Ø¯Ù‘Ù„ Ø§Ù„Ù‚ÙŠÙ… Ù‡Ù†Ø§ Ø­Ø³Ø¨ Ø´ÙŠØªÙƒ:
    - MASTER_NAME: Ø§Ù„Ø§Ø³Ù… Ø§Ù„Ø¸Ø§Ù‡Ø± Ø£Ø¹Ù„Ù‰ Ø§Ù„ØµÙØ­Ø©
    - SPREADSHEET_ID: Ù…Ø¹Ø±Ù Ù…Ù„Ù Google Sheet (Ø¨ÙŠÙ† /d/ Ùˆ /edit)
    - EXAMS_URL: Ø±Ø§Ø¨Ø· ØµÙØ­Ø© Ø§Ù„Ø§Ù…ØªØ­Ø§Ù†Ø§Øª
    - SHEET_NAMES: Ø£Ø³Ù…Ø§Ø¡ Ø§Ù„Ø´ÙŠØªØ§Øª Ø¯Ø§Ø®Ù„ Ø§Ù„Ù…Ù„Ù (ÙƒÙ…Ø§ Ù‡ÙŠ Ù…ÙƒØªÙˆØ¨Ø© ÙÙŠ Google Sheets)
  
  Ù…Ù„Ø§Ø­Ø¸Ø©: Ø§Ù„Ø³ÙƒØ±Ø¨Øª ÙŠØ³ØªØ®Ø¯Ù… Ø±Ø§Ø¨Ø· gviz Ù„ØªØµØ¯ÙŠØ± ÙƒÙ„ Ø´ÙŠØª ÙƒÙ€ JSON:
  https://docs.google.com/spreadsheets/d/<ID>/gviz/tq?tqx=out:json&sheet=<SHEET_NAME>
*/

const MASTER_NAME = " Ø¯ÙƒØªÙˆØ± Ø§ÙŠÙ…Ù† Ø¹Ø¨Ø¯Ø§Ù„Ø±Ø­ÙŠÙ… "; // ØºÙŠØ±Ù‡ Ù‡Ù†Ø§ Ø£Ùˆ Ø¹Ø¯Ù‘Ù„Ù‡ Ù…Ù† Ø§Ù„Ù€ contenteditable ÙÙŠ Ø§Ù„Ø£Ø¹Ù„Ù‰
const SPREADSHEET_ID = "1lv6jHrJeZhla73c2BFHcNE9sCoHwAvCt6faSnD5yp9Y"; // <-- Ø¶Ø¹ Ù‡Ù†Ø§ Ù…Ø¹Ø±Ù Ø§Ù„Ø´ÙŠØª
const EXAMS_URL = "https://your-exams-site.example";     // <-- Ø¶Ø¹ Ø±Ø§Ø¨Ø· Ø§Ù„Ø§Ù…ØªØ­Ø§Ù†Ø§Øª Ù‡Ù†Ø§

const SHEET_NAMES = {
  grade1: "CodeGrade1",
  grade2: "CodeGrade2",
  grade3: "CodeGrade3",
  videos: "Videos"
};

/* =========================
   ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ©
   ========================= */
const $ = id => document.getElementById(id);
const snackbar = $('snackbar');

function showSnackbar(text, type = 'info', duration = 3000) {
  snackbar.textContent = text;
  snackbar.className = 'snackbar show';
  if (type === 'success') snackbar.classList.add('success');
  else if (type === 'error') snackbar.classList.add('error');

  setTimeout(() => {
    snackbar.className = 'snackbar';
  }, duration);
}

/* Ø­ÙØ¸ Ø§Ø³Ù… Ø§Ù„Ù…Ø¯Ø±Ø³ Ù…Ø­Ù„ÙŠÙ‹Ø§ */
const masterEl = $('masterName');
masterEl.addEventListener('input', () => localStorage.setItem('masterName', masterEl.textContent.trim()));
const savedMaster = localStorage.getItem('masterName');
if (savedMaster) masterEl.textContent = savedMaster;
else masterEl.textContent = MASTER_NAME;

/* Ø²Ø± Ø§Ù„Ø§Ù…ØªØ­Ø§Ù†Ø§Øª */
$('examsBtn').addEventListener('click', () => {
  const url = (EXAMS_URL && EXAMS_URL !== "https://your-exams-site.example") ? EXAMS_URL : prompt("Ø¶Ø¹ Ø±Ø§Ø¨Ø· ØµÙØ­Ø© Ø§Ù„Ø§Ù…ØªØ­Ø§Ù†Ø§Øª:");
  if (url) window.open(url, '_blank');
});

/* Ø²Ø± Ø¹Ø±Ø¶ Ø§Ù„Ù…Ø­Ø§Ø¶Ø±Ø© */
$('showBtn').addEventListener('click', async () => {
  const codeRaw = $('studentCode').value.trim();
  if (!codeRaw) { showSnackbar('Ù…Ù† ÙØ¶Ù„Ùƒ Ø£Ø¯Ø®Ù„ Ø§Ù„ÙƒÙˆØ¯ Ø£ÙˆÙ„Ø§Ù‹', 'error'); return; }
  const code = codeRaw.toUpperCase();

  // grade sheet name
  const grade = $('gradeSelect').value;
  if (!SPREADSHEET_ID || SPREADSHEET_ID === "PUT_YOUR_SPREADSHEET_ID_HERE") {
    showSnackbar('Ø¶Ø¹ Ù…Ø¹Ø±Ù Google Sheet ÙÙŠ Ø§Ù„ÙƒÙˆØ¯ Ø£ÙˆÙ„Ø§Ù‹ (SPREADSHEET_ID).', 'error', 5000);
    return;
  }

  try {
    // show loading
    $('loadingRow').style.display = 'flex';
    $('videoStatus').textContent = 'Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø¨Ø­Ø«...';
    $('videoFrame').style.display = 'none';
    $('videoFrame').src = '';

    // 1) Ø¬Ù„Ø¨ Ø´ÙŠØª Ø§Ù„ØµÙ Ø§Ù„Ù…Ø®ØªØ§Ø±
    const gradeRows = await fetchSheetAsArray(SPREADSHEET_ID, grade);
    if (!gradeRows || gradeRows.length < 1) {
      throw new Error('Ù…Ù„Ù Ø§Ù„ØµÙ ÙØ§Ø±Øº Ø£Ùˆ ØºÙŠØ± Ù…ØªØ§Ø­.');
    }
    // header = Ø£Ø³Ù…Ø§Ø¡ Ø§Ù„Ø¯Ø±ÙˆØ³ ÙÙŠ Ø§Ù„ØµÙ (Ø£Ø¹Ù…Ø¯Ø©)
    const header = gradeRows[0].map(h => (h || '').toString().trim());
    // Ø¨Ù†Ø§Ø¡ Ø¨Ø­Ø« Ø§Ù„ÙƒÙˆØ¯: scan ÙƒÙ„ Ø¹Ù…ÙˆØ¯ (Ù…Ù† Ø§Ù„ØµÙ 2 Ø¥Ù„Ù‰ Ø¢Ø®Ø±) ÙˆÙ…ÙˆØ§Ø¡Ù…Ø©
    let found = null; // { lessonName, colIndex }
    for (let col = 0; col < header.length; col++) {
      const lessonName = header[col] || `Ø¯Ø±Ø³ ${col+1}`;
      for (let r = 1; r < gradeRows.length; r++) {
        const cell = (gradeRows[r][col] || '').toString().trim();
        if (!cell) continue;
        if (cell.toUpperCase() === code) {
          found = { lessonName, colIndex: col };
          break;
        }
      }
      if (found) break;
    }

    if (!found) {
      $('loadingRow').style.display = 'none';
      $('videoStatus').textContent = 'Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø§Ù„ÙƒÙˆØ¯';
      showSnackbar('Ø§Ù„ÙƒÙˆØ¯ ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯ ÙÙŠ Ø´ÙŠØª Ø§Ù„ØµÙ Ø§Ù„Ù…Ø®ØªØ§Ø±.', 'error', 4000);
      return;
    }

    // 2) Ø¬Ù„Ø¨ Ø´ÙŠØª Videos
    const videosRows = await fetchSheetAsArray(SPREADSHEET_ID, SHEET_NAMES.videos);
    // Ù†ØªÙˆÙ‚Ø¹ Ø¬Ø¯ÙˆÙ„ Ø¨Ø³ÙŠØ·: Ø¹Ù…ÙˆØ¯ Ø§Ø³Ù… Ø§Ù„Ø¯Ø±Ø³ â€” Ø¹Ù…ÙˆØ¯ Ø±Ø§Ø¨Ø· Ø§Ù„ÙÙŠØ¯ÙŠÙˆ
    const videosMap = {}; // lesson -> link
    if (videosRows && videosRows.length > 0) {
      // Ù†Ø­Ø§ÙˆÙ„ Ø§ÙƒØªØ´Ø§Ù Ø§Ù„Ø£Ø¹Ù…Ø¯Ø©: ØºØ§Ù„Ø¨Ù‹Ø§ Ø§Ù„Ø¹Ù…ÙˆØ¯ Ø§Ù„Ø£ÙˆÙ„ Ø§Ø³Ù…ØŒ Ø§Ù„Ø«Ø§Ù†ÙŠ Ø±Ø§Ø¨Ø·
      // Ù„ÙƒÙ† Ø³Ù†ØªØ¹Ø§Ù…Ù„ Ø¨Ù…Ø±ÙˆÙ†Ø©: Ù„Ùˆ Ø£ÙˆÙ„ ØµÙ Ø±Ø¤ÙˆØ³ ÙˆØ­ØªØ´Ù…Ù„ 'lesson' Ø£Ùˆ 'Ø¯Ø±Ø³' Ùˆ 'link'ØŒ Ù†ØªØ®Ø·Ù‰
      let startRow = 0;
      const firstRow = videosRows[0].map(c => (c||'').toString().toLowerCase());
      const headerCandidates = ['lesson','Ø¯Ø±Ø³','name','video','link','Ù„ÙŠÙ†Ùƒ','url'];
      if (firstRow.some(c => headerCandidates.some(h => c.includes(h)))) startRow = 1;

      // Ø§ÙØªØ±Ø§Ø¶: Ø§Ù„Ø¹Ù…ÙˆØ¯ Ø§Ù„Ø£ÙˆÙ„ Ø§Ø³Ù…ØŒ Ø§Ù„Ø¹Ù…ÙˆØ¯ Ø§Ù„Ø«Ø§Ù†ÙŠ Ø±Ø§Ø¨Ø· â€” Ù„ÙƒÙ† Ù„Ùˆ ÙÙŠÙ‡ Ø£ÙƒØ«Ø± Ø­Ø§ÙˆÙ„ Ø§Ø®ØªÙŠØ§Ø± Ø£Ø¹Ù…Ø¯Ø© Ø°ÙƒÙŠØ©
      for (let r = startRow; r < videosRows.length; r++) {
        const row = videosRows[r];
        const name = (row[0] || '').toString().trim();
        const link = (row[1] || '').toString().trim();
        if (name && link) videosMap[name] = link;
      }
      // Ø£ÙŠØ¶Ø§Ù‹ Ø­Ø§ÙˆÙ„ Ø§Ù„Ø¨Ø­Ø« Ø¥Ø°Ø§ ÙƒØ§Ù† Ø§Ù„ØµÙ Ø§Ù„Ø£ÙˆÙ„ ÙŠØªØ¶Ù…Ù† Ø£Ø²ÙˆØ§Ø¬ Ø§Ø³Ù…/Ù„ÙŠÙ†Ùƒ Ø¨Ø´ÙƒÙ„ Ù…Ø®ØªÙ„Ù
      // (Ù„Ùˆ Ù„Ù… ÙŠØ¹Ø·Ù Ø´ÙŠØ¡ØŒ Ø³Ù†Ø¹Ø·ÙŠ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø®ÙŠØ§Ø± Ø¥Ø¯Ø®Ø§Ù„ Ù„ÙŠÙ†Ùƒ ÙŠØ¯ÙˆÙŠ)
    }

    // 3) Ø¬Ù„Ø¨ Ø§Ù„Ù„ÙŠÙ†Ùƒ Ù…Ù† Ø§Ù„Ø®Ø±ÙŠØ·Ø©
    const lesson = found.lessonName;
    let link = videosMap[lesson];

    if (!link) {
      // Ø§Ø¨Ø±Ø§Ø² Ù…Ù†Ø·Ù‚Ø© Ø§Ù„Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„ÙŠØ¯ÙˆÙŠ
      $('loadingRow').style.display = 'none';
      $('videoStatus').textContent = `ØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø§Ù„ÙƒÙˆØ¯ Ù„Ø¯Ø±Ø³: ${lesson} (Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù„ÙŠÙ†Ùƒ Ù…ÙØ³Ø¬Ù‘Ù„)`;
      $('manualArea').style.display = 'flex';
      $('manualLink').value = '';
      showSnackbar('ÙˆØ¬Ø¯Øª Ø§Ù„ÙƒÙˆØ¯ Ù„ÙƒÙ† Ù„Ù… Ø£Ø¬Ø¯ Ø±Ø§Ø¨Ø· Ø§Ù„Ù…Ø­Ø§Ø¶Ø±Ø©. Ø¶Ø¹ Ø§Ù„Ø±Ø§Ø¨Ø· ÙŠØ¯ÙˆÙŠØ§Ù‹ Ø£Ùˆ Ø§Ø·Ù„Ø¨ Ù…Ù† Ø§Ù„Ù…Ø¯Ø±Ø³ ØªØ­Ø¯ÙŠØ« Ø´ÙŠØª Videos.', 'info', 6000);

      $('useManual').onclick = () => {
        const manual = $('manualLink').value.trim();
        if (!manual) { showSnackbar('Ø¶Ø¹ Ø±Ø§Ø¨Ø· Ø§Ù„ÙÙŠØ¯ÙŠÙˆ Ø£ÙˆÙ„Ø§Ù‹', 'error'); return; }
        link = manual;
        loadAndShowVideo(link, lesson);
        $('manualArea').style.display = 'none';
      };
      return;
    }

    // 4) Ø¹Ø±Ø¶ Ø§Ù„ÙÙŠØ¯ÙŠÙˆ
    loadAndShowVideo(link, lesson);

  } catch (err) {
    console.error(err);
    showSnackbar('Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„Ø¹Ù…Ù„ÙŠØ©: ' + (err.message || err), 'error', 6000);
    $('videoStatus').textContent = 'Ø­Ø¯Ø« Ø®Ø·Ø£';
    $('loadingRow').style.display = 'none';
  }
});

function loadAndShowVideo(rawLink, lesson) {
  // âœ… Ø¯Ø§Ù„Ø© Ù„ØªØ­ÙˆÙŠÙ„ Ø£ÙŠ Ù„ÙŠÙ†Ùƒ ÙŠÙˆØªÙŠÙˆØ¨ Ø¥Ù„Ù‰ Ø´ÙƒÙ„ embed
  function convertYouTubeLink(link) {
    if (!link) return "";
    link = link.trim();

    // Ù„Ùˆ Ø§Ù„Ø±Ø§Ø¨Ø· Ø¨ØµÙŠØºØ© youtu.be
    if (link.includes("youtu.be")) {
      return link.replace("https://youtu.be/", "https://www.youtube.com/embed/").split("?")[0];
    }

    // Ù„Ùˆ Ø§Ù„Ø±Ø§Ø¨Ø· Ø¨ØµÙŠØºØ© watch?v=
    if (link.includes("watch?v=")) {
      return link.replace("watch?v=", "embed/").split("&")[0];
    }

    // Ù„Ùˆ Ø¨Ø§Ù„ÙØ¹Ù„ embed
    if (link.includes("/embed/")) {
      return link.split("?")[0];
    }

    // fallback Ù„Ùˆ Ù…Ø´ ÙŠÙˆØªÙŠÙˆØ¨
    return link;
  }

  // ğŸ§© ØªØ­ÙˆÙŠÙ„ Ø§Ù„Ø±Ø§Ø¨Ø· Ø§Ù„Ø¹Ø§Ø¯ÙŠ Ø¥Ù„Ù‰ embed
  const final = convertYouTubeLink(rawLink);

  // Ø¹Ø±Ø¶ Ø§Ù„ÙÙŠØ¯ÙŠÙˆ ÙÙŠ Ø§Ù„Ø¥Ø·Ø§Ø±
  const frame = $('videoFrame');
  frame.src = final;
  frame.style.display = 'block';
  $('videoTitle').textContent = lesson;
  $('videoStatus').textContent = 'ÙŠØªÙ… Ø¹Ø±Ø¶ Ø§Ù„Ù…Ø­Ø§Ø¶Ø±Ø© Ø§Ù„Ø¢Ù†';
  $('loadingRow').style.display = 'none';
  showSnackbar('ØªÙ… Ø¹Ø±Ø¶ Ø§Ù„Ù…Ø­Ø§Ø¶Ø±Ø© Ø¨Ù†Ø¬Ø§Ø­', 'success', 2500);
}


/* =========================
   Ø¯ÙˆØ§Ù„ ØªØ­Ù…ÙŠÙ„ Ø´ÙŠØª Ù…Ù† Google (gviz -> JSON)
   ========================= */
async function fetchSheetAsArray(spreadsheetId, sheetName) {
  // Ø¨Ù†Ø³ØªØ®Ø¯Ù… gviz Ù„ØªØµØ¯ÙŠØ± Ø§Ù„Ø´ÙŠØª ÙƒÙ€ JSON
  const url = `https://docs.google.com/spreadsheets/d/${spreadsheetId}/gviz/tq?tqx=out:json&sheet=${encodeURIComponent(sheetName)}`;
  const res = await fetch(url);
  if (!res.ok) throw new Error('ÙØ´Ù„ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø´ÙŠØª: ' + sheetName);
  const txt = await res.text();
  const json = parseGvizJson(txt);
  if (!json || !json.table) return null;
  // ØªØ­ÙˆÙŠÙ„ Ø¥Ù„Ù‰ Ù…ØµÙÙˆÙØ© ØµÙÙˆÙ x Ø£Ø¹Ù…Ø¯Ø© (Ù‚ÙŠÙ… Ù†ØµÙŠØ©)
  const rows = [];
  const colsCount = json.table.cols.length;
  for (let r = 0; r < json.table.rows.length; r++) {
    const row = json.table.rows[r].c || [];
    const arr = new Array(colsCount).fill('');
    for (let c = 0; c < colsCount; c++) {
      if (row[c] && row[c].v !== null && row[c].v !== undefined) arr[c] = row[c].v;
    }
    rows.push(arr);
  }
  return rows;
}

function parseGvizJson(text) {
  // gviz ÙŠØ±Ø¯ Ø¨ØµÙŠØºØ©: /*O_o*/\ngoogle.visualization.Query.setResponse({...});
  try {
    const m = text.match(/google\.visualization\.Query\.setResponse\(([\s\S]*)\);?/);
    if (!m) return null;
    return JSON.parse(m[1]);
  } catch (e) {
    console.error('parseGvizJson failed', e);
    return null;
  }
}

/* Ù…Ø³Ø§Ø¹Ø¯Ø©: Ø§Ù„Ø¶ØºØ· Enter Ø¯Ø§Ø®Ù„ Ø­Ù‚Ù„ Ø§Ù„ÙƒÙˆØ¯ */
$('studentCode').addEventListener('keydown', (e) => {
  if (e.key === 'Enter') $('showBtn').click();
});
</script>
</body>
</html>
